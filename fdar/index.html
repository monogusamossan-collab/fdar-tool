<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FDAR è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</title>

  <style>
    :root { color-scheme: light dark; }

    body{
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      margin:0; padding:18px;
      max-width:860px;
      line-height:1.45;
    }
    h1{ font-size:22px; margin:0 0 8px; }
    .subTitle{ margin:0 0 14px; opacity:.85; font-size:14px; }

    .card{
      border:1px solid rgba(127,127,127,.35);
      border-radius:16px;
      padding:14px;
      background: rgba(127,127,127,.10);
    }

    label{ display:block; font-size:13px; opacity:.9; margin:10px 0 6px; }

    input, textarea{
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      font-size:16px;          /* iPhoneã§æ‹¡å¤§/å´©ã‚Œé˜²æ­¢ã®åŸºæœ¬ */
      border:1px solid rgba(127,127,127,.35);
      border-radius:12px;
      padding:12px;
      background: rgba(127,127,127,.12);
      color: inherit;
      outline:none;
    }
    textarea{
      min-height:84px;
      resize: vertical;
    }

    /* æ—¥ä»˜ãŒã¯ã¿å‡ºã‚‹å¯¾ç­–ï¼ˆiPhoneï¼‰ */
    input[type="date"]{
      -webkit-appearance: none;
      appearance: none;
      display:block;
      line-height:1.2;
      padding:12px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row > div{
      flex:1 1 220px;
      min-width:220px;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid rgba(127,127,127,.35);
      border-radius:12px;
      padding:12px 14px;
      font-size:16px;
      background: rgba(127,127,127,.12);
      color: inherit;
    }
    button.primary{
      background: rgba(100,160,255,.25);
      border-color: rgba(100,160,255,.45);
    }

    .badge{
      display:inline-block;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.12);
      font-size:14px;
    }

    /* å³ä¸‹ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ï¼ˆæŠ¼ã›ãªã„å•é¡Œã®å¯¾ç­–è¾¼ã¿ï¼‰ */
    .micBtn{
      position: fixed;
      right: 14px;
      bottom: 18px;
      z-index: 9999;
      pointer-events: auto;
      border-radius: 999px;
      padding: 14px 16px;
      background: rgba(0,0,0,.80);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      font-size: 15px;
      box-shadow: 0 6px 18px rgba(0,0,0,.22);
    }

    .preview{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.08);
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <h1>FDAR è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
  <p class="subTitle">å…¥åŠ›ã—ã¦ã€Œã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚³ãƒ”ãƒ¼ã€ã§FDARå½¢å¼ã«æ•´å½¢ã—ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸é€ã‚Šã¾ã™ã€‚</p>

  <div class="card">
    <div class="row">
      <div>
        <label for="client">åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«æ¨å¥¨ï¼‰</label>
        <input id="client" placeholder="ä¾‹ï¼šAæ§˜ / KM ãªã©ï¼ˆå€‹äººãŒç‰¹å®šã§ãã‚‹æƒ…å ±ã¯é¿ã‘ã¦ãã ã•ã„ï¼‰" />
      </div>
      <div>
        <label for="date">æ—¥ä»˜</label>
        <input id="date" type="date" />
      </div>
    </div>

    <label for="f">Fï¼ˆFocusï¼‰</label>
    <textarea id="f" placeholder="ä¾‹ï¼šæœ¬æ—¥ã®ç„¦ç‚¹ã€èª²é¡Œã€ä¸»è¨´ãªã©"></textarea>

    <label for="d">Dï¼ˆDataï¼‰</label>
    <textarea id="d" placeholder="ä¾‹ï¼šãƒã‚¤ã‚¿ãƒ«ã€æ‰€è¦‹ã€å‹•ä½œã€è¦³å¯Ÿãªã©"></textarea>

    <label for="a">Aï¼ˆActionï¼‰</label>
    <textarea id="a" placeholder="ä¾‹ï¼šå®Ÿæ–½å†…å®¹ã€ä»‹å…¥ã€æŒ‡å°ãªã©"></textarea>

    <label for="r">Rï¼ˆResponseï¼‰</label>
    <textarea id="r" placeholder="ä¾‹ï¼šåå¿œã€å¤‰åŒ–ã€è©•ä¾¡ãªã©"></textarea>

    <div class="btns">
      <button class="primary" id="copy">ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚³ãƒ”ãƒ¼</button>
      <button id="clear">å…¨æ¶ˆå»</button>
      <span class="badge" id="status">å¾…æ©Ÿä¸­</span>
    </div>

    <div class="preview" id="preview"></div>
  </div>

  <button class="micBtn" id="mic">ğŸ™ éŸ³å£°é–‹å§‹</button>

  <script>
    // åˆæœŸæ—¥ä»˜ï¼ˆç©ºãªã‚‰ä»Šæ—¥ï¼‰
    (function initDate(){
      const el = document.getElementById('date');
      if (!el.value) {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        el.value = `${yyyy}-${mm}-${dd}`;
      }
    })();

    const $ = (id)=>document.getElementById(id);

    // ===== æœ€å¾Œã«è§¦ã£ãŸå…¥åŠ›æ¬„ã‚’è¦šãˆã‚‹ï¼ˆiPhoneå¯¾ç­–ï¼špointerdownã‚‚æ‹¾ã†ï¼‰ =====
    let lastFieldId = 'f';
    const targetIds = ['f','d','a','r'];

    function setLast(id){
      if (targetIds.includes(id)) lastFieldId = id;
    }

    targetIds.concat(['client','date']).forEach(id=>{
      const el = $(id);
      if(!el) return;
      ['focus','click','pointerdown','touchstart'].forEach(ev=>{
        el.addEventListener(ev, ()=> setLast(id));
      });
    });

    function getTargetFieldId(){
      const ae = document.activeElement;
      if (ae && targetIds.includes(ae.id)) return ae.id;
      if (targetIds.includes(lastFieldId)) return lastFieldId;
      return 'f';
    }

    // ===== FDARæ•´å½¢ =====
    function buildText(){
      const client = $('client').value.trim();
      const date = $('date').value ? $('date').value : '';
      const f = $('f').value.trim();
      const d = $('d').value.trim();
      const a = $('a').value.trim();
      const r = $('r').value.trim();

      const head = `${date}${client ? ' / ' + client : ''}`.trim();
      const lines = [];
      if (head) lines.push(head);
      lines.push(`Fï¼š${f}`);
      lines.push(`Dï¼š${d}`);
      lines.push(`Aï¼š${a}`);
      lines.push(`Rï¼š${r}`);
      return lines.join('\n');
    }

    function render(){
      $('preview').textContent = buildText();
    }
    ['client','date','f','d','a','r'].forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener('input', render);
    });
    render();

    // ===== ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ =====
    $('copy').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(buildText());
        $('status').textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
      }catch(e){
        $('status').textContent = 'ã‚³ãƒ”ãƒ¼å¤±æ•—ï¼ˆæ¨©é™/ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰';
      }
    });

    $('clear').addEventListener('click', ()=>{
      ['client','f','d','a','r'].forEach(id=> $(id).value = '');
      render();
      $('status').textContent = 'å…¨æ¶ˆå»';
      setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
    });

    // ===== éŸ³å£°å…¥åŠ› =====
    let rec = null;
    let listening = false;

    function getSR(){
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }

    function ensureRec(){
      if (rec) return rec;
      const SR = getSR();
      if (!SR) return null;

      rec = new SR();
      rec.lang = 'ja-JP';
      rec.interimResults = true;
      rec.continuous = true;

      rec.onresult = (e)=>{
        let text = '';
        for(let i=e.resultIndex;i<e.results.length;i++){
          text += e.results[i][0].transcript;
        }
        text = (text || '').trim();
        if(!text) return;

        const id = getTargetFieldId();
        const el = $(id);
        el.value = (el.value + (el.value ? '\n' : '') + text);
        render();
      };

      rec.onend = ()=>{
        if(listening){
          try{ rec.start(); }catch(_){}
        }
      };

      rec.onerror = ()=>{
        $('status').textContent = 'éŸ³å£°ã‚¨ãƒ©ãƒ¼';
        listening = false;
        $('mic').textContent = 'ğŸ™ éŸ³å£°é–‹å§‹';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
      };

      return rec;
    }

    $('mic').addEventListener('click', ()=>{
      const SR = getSR();
      if(!SR){
        $('status').textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œ';
        return;
      }
      ensureRec();

      if(!listening){
        listening = true;
        $('status').textContent = 'éŸ³å£°å…¥åŠ›ä¸­';
        $('mic').textContent = 'ğŸ›‘ éŸ³å£°åœæ­¢';
        try{ rec.start(); }catch(_){}
      }else{
        listening = false;
        $('status').textContent = 'å¾…æ©Ÿä¸­';
        $('mic').textContent = 'ğŸ™ éŸ³å£°é–‹å§‹';
        try{ rec.stop(); }catch(_){}
      }
    });
  </script>
</body>
</html>
