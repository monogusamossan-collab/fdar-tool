<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FDAR è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <style>
    :root { color-scheme: light dark; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      margin:0; padding:18px; max-width:860px; line-height:1.45;
    }
    h1{ font-size:22px; margin:0 0 10px; }
    .subTitle{ margin:0 0 14px; opacity:.85; }
    .card{
      border:1px solid rgba(127,127,127,.35);
      border-radius:16px;
      padding:14px;
      background:rgba(127,127,127,.10);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width:640px){
      .row{ grid-template-columns:1fr; }
    }
    label{ display:block; font-size:13px; opacity:.9; margin:0 0 6px; }
    input, textarea{
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      font-size:16px;
      display:block;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(127,127,127,.35);
      background:rgba(127,127,127,.10);
      color:inherit;
      outline:none;
    }
    textarea{ min-height:92px; resize:vertical; }
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      align-items:center;
    }
    button{
      border:1px solid rgba(127,127,127,.35);
      background:rgba(127,127,127,.12);
      color:inherit;
      padding:12px 14px;
      border-radius:12px;
      font-size:15px;
    }
    button.primary{
      background:rgba(80,140,255,.18);
      border-color:rgba(80,140,255,.45);
    }
    button:disabled{ opacity:.5; }

    .badge{
      display:inline-block;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(127,127,127,.35);
      background:rgba(0,0,0,.08);
      font-size:13px;
      opacity:.95;
    }

    .micBtn{
      position:fixed;
      right:14px;
      bottom:18px;
      z-index:9999;
      border:1px solid rgba(127,127,127,.35);
      background:rgba(0,0,0,.80);
      color:#fff;
      border-radius:999px;
      padding:14px 16px;
      font-size:15px;
      box-shadow: 0 8px 24px rgba(0,0,0,.22);
    }

    pre{
      white-space:pre-wrap;
      word-break:break-word;
      border:1px solid rgba(127,127,127,.35);
      background:rgba(127,127,127,.08);
      border-radius:12px;
      padding:12px;
      margin-top:12px;
      min-height:80px;
    }
    .hint{ font-size:12px; opacity:.75; margin-top:8px; }
  </style>
</head>

<body>
  <h1>FDAR è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
  <p class="subTitle">å…¥åŠ›ã—ã¦ã€Œã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚³ãƒ”ãƒ¼ã€ã§ã€FDARå½¢å¼ã«æ•´å½¢ã—ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸é€ã‚Šã¾ã™ã€‚</p>

  <div class="card">
    <div class="row">
      <div>
        <label>åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«æ¨å¥¨ï¼‰</label>
        <input id="client" placeholder="ä¾‹ï¼šAæ§˜ / KM ãªã©ï¼ˆå€‹äººãŒç‰¹å®šã§ãã‚‹æƒ…å ±ã¯é¿ã‘ã‚‹ï¼‰" />
      </div>
      <div>
        <label>æ—¥ä»˜</label>
        <input id="date" type="date" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Fï¼ˆFocusï¼‰</label>
        <textarea id="f" placeholder="ä¾‹ï¼šæœ¬æ—¥ã®ç„¦ç‚¹ã€èª²é¡Œã€ä¸»è¨´ãªã©"></textarea>
      </div>
      <div>
        <label>Dï¼ˆDataï¼‰</label>
        <textarea id="d" placeholder="ä¾‹ï¼šãƒã‚¤ã‚¿ãƒ«ã€æ‰€è¦‹ã€å‹•ä½œã€è¦³å¯Ÿãªã©"></textarea>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Aï¼ˆActionï¼‰</label>
        <textarea id="a" placeholder="ä¾‹ï¼šå®Ÿæ–½å†…å®¹ã€ä»‹å…¥ã€æŒ‡å°ãªã©"></textarea>
      </div>
      <div>
        <label>Rï¼ˆResponseï¼‰</label>
        <textarea id="r" placeholder="ä¾‹ï¼šåå¿œã€å¤‰åŒ–ã€è©•ä¾¡ãªã©"></textarea>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="copy">ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚³ãƒ”ãƒ¼</button>
      <button id="clear">å…¨æ¶ˆå»</button>
      <button id="save">ã“ã®å†…å®¹ã‚’ä¿å­˜</button>
      <button id="load">ä¿å­˜ã‚’èª­ã¿è¾¼ã¿</button>
      <span class="badge" id="status">å¾…æ©Ÿä¸­</span>
    </div>

    <div class="hint">éŸ³å£°å…¥åŠ›ï¼šå…¥ã‚ŒãŸã„æ¬„ï¼ˆF/D/A/Rï¼‰ã‚’ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã€å³ä¸‹ã®ã€ŒéŸ³å£°é–‹å§‹ã€ã€‚</div>

    <pre id="preview"></pre>
  </div>

  <button class="micBtn" id="mic" type="button">ğŸ™ éŸ³å£°é–‹å§‹</button>

  <script>
    // ===== åˆæœŸæ—¥ä»˜ =====
    (function initDate(){
      const el = document.getElementById('date');
      if (!el.value) {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        el.value = `${yyyy}-${mm}-${dd}`;
      }
    })();

    const $ = (id)=>document.getElementById(id);

    // ===== æœ€å¾Œã«è§¦ã£ãŸå…¥åŠ›æ¬„ã‚’è¦šãˆã‚‹ï¼ˆiPhoneå¯¾ç­–ã®æœ¬ä½“ï¼‰ =====
    let lastFieldId = '';
    const targetIds = ['f','d','a','r'];

    function setLast(id){
      if (targetIds.includes(id)) lastFieldId = id;
    }

    // iOSã¯ focus ãŒé£›ã¶ã“ã¨ãŒã‚ã‚‹ã®ã§ã€pointer ç³»ã‚‚æ‹¾ã†
    targetIds.forEach(id=>{
      const el = $(id);
      el.addEventListener('focus', ()=>setLast(id));
      el.addEventListener('click', ()=>setLast(id));
      el.addEventListener('pointerdown', ()=>setLast(id));
      el.addEventListener('touchstart', ()=>setLast(id), {passive:true});
    });

    // ===== ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ =====
    function buildText(){
      const client = $('client').value.trim();
      const date = $('date').value ? $('date').value : '';
      const f = $('f').value.trim();
      const d = $('d').value.trim();
      const a = $('a').value.trim();
      const r = $('r').value.trim();

      const head = `${date}${client ? ' / ' + client : ''}`.trim();

      const lines = [];
      if (head) lines.push(head);
      lines.push(`Fï¼š${f}`);
      lines.push(`Dï¼š${d}`);
      lines.push(`Aï¼š${a}`);
      lines.push(`Rï¼š${r}`);
      return lines.join('\n');
    }

    function render(){
      $('preview').textContent = buildText();
    }

    // å…¥åŠ›ã§å³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    ['client','date','f','d','a','r'].forEach(id=>{
      $(id).addEventListener('input', render);
      $(id).addEventListener('change', render);
    });

    // ===== ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ =====
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        $('status').textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1400);
      }catch(e){
        $('status').textContent = 'ã‚³ãƒ”ãƒ¼å¤±æ•—ï¼ˆé•·æŠ¼ã—ã§ã‚³ãƒ”ãƒ¼ï¼‰';
      }
    }

    $('copy').addEventListener('click', ()=>{
      render();
      copyToClipboard($('preview').textContent);
    });

    $('clear').addEventListener('click', ()=>{
      ['client','f','d','a','r'].forEach(id=> $(id).value = '');
      render();
      $('status').textContent = 'æ¶ˆå»ã—ã¾ã—ãŸ';
      setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
      lastFieldId = 'f';
    });

    // ===== ä¿å­˜/èª­ã¿è¾¼ã¿ï¼ˆlocalStorageï¼‰ =====
    const KEY = 'fdar_tool_v1';
    $('save').addEventListener('click', ()=>{
      const payload = {
        client:$('client').value,
        date:$('date').value,
        f:$('f').value,
        d:$('d').value,
        a:$('a').value,
        r:$('r').value,
      };
      localStorage.setItem(KEY, JSON.stringify(payload));
      $('status').textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
      setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
    });

    $('load').addEventListener('click', ()=>{
      const raw = localStorage.getItem(KEY);
      if(!raw){
        $('status').textContent = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
        return;
      }
      try{
        const p = JSON.parse(raw);
        $('client').value = p.client || '';
        $('date').value = p.date || $('date').value;
        $('f').value = p.f || '';
        $('d').value = p.d || '';
        $('a').value = p.a || '';
        $('r').value = p.r || '';
        render();
        $('status').textContent = 'èª­ã¿è¾¼ã¿ã¾ã—ãŸ';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
      }catch(e){
        $('status').textContent = 'èª­ã¿è¾¼ã¿å¤±æ•—';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
      }
    });

    // ===== éŸ³å£°å…¥åŠ› =====
    let rec = null;
    let listening = false;

    function getSR(){
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }

    function ensureRec(){
      const SR = getSR();
      if(!SR) return null;
      if(rec) return rec;

      rec = new SR();
      rec.lang = 'ja-JP';
      rec.interimResults = true;
      rec.continuous = true;

      rec.onresult = (e)=>{
        let text = '';
        for(let i = e.resultIndex; i < e.results.length; i++){
          text += e.results[i][0].transcript;
        }
        text = (text || '').trim();
        if(!text) return;

        // â˜…ã“ã“ãŒé‡è¦ï¼šactiveElementã¯è¦‹ãªã„ã€‚lastFieldIdã ã‘ã§æ±ºã‚ã‚‹
        const id = lastFieldId || 'f';
        const el = $(id);

        // è¿½è¨˜ï¼ˆæ”¹è¡ŒæŒ¿å…¥ï¼‰
        el.value = (el.value + (el.value ? '\n' : '') + text).trim();
        render();
      };

      rec.onend = ()=>{
        // continuousã§ã‚‚iOSã¯åˆ‡ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ONãªã‚‰å†é–‹
        if(listening){
          try{ rec.start(); }catch(_){}
        }
      };

      rec.onerror = ()=>{
        $('status').textContent = 'éŸ³å£°ã‚¨ãƒ©ãƒ¼';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
      };

      return rec;
    }

    $('mic').addEventListener('click', ()=>{
       $('status').textContent =
    'SR=' + (!!(window.SpeechRecognition || window.webkitSpeechRecognition));

      const SR = getSR();
      if(!SR){
        $('status').textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œ';
        return;
      }

      ensureRec();

      if(!listening){
        listening = true;
        $('status').textContent = 'éŸ³å£°å…¥åŠ›ä¸­';
        $('mic').textContent = 'ğŸ›‘ éŸ³å£°åœæ­¢';

        try{ rec.start(); }catch(_){}
      }else{
        listening = false;
        $('status').textContent = 'å¾…æ©Ÿä¸­';
        $('mic').textContent = 'ğŸ™ éŸ³å£°é–‹å§‹';

        try{ rec.stop(); }catch(_){}
      }
    });

    // åˆæœŸæç”»
    render();
  </script>
</body>
</html>
