<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼ï½œFDARç‰ˆ</title>

  <meta name="apple-mobile-web-app-title" content="FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼" />
  <meta name="application-name" content="FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼" />

  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 18px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .subTitle { opacity: .85; font-size: 13px; margin: 0 0 14px; line-height: 1.4; }
    .card { border: 1px solid rgba(127,127,127,.35); border-radius: 14px; padding: 14px; }
    label { display:block; font-size: 12px; opacity: .8; margin: 10px 0 6px; }
    input, textarea { width: 100%; box-sizing: border-box; border-radius: 12px; border: 1px solid rgba(127,127,127,.35); padding: 10px 12px; background: rgba(0,0,0,.03); }
    textarea { min-height: 74px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btnRow { display:flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button { border-radius: 14px; padding: 10px 12px; border: 1px solid rgba(127,127,127,.35); background: rgba(0,0,0,.06); cursor:pointer; }
    button.primary { background: rgba(20,120,255,.15); border-color: rgba(20,120,255,.35); }
    .out { margin-top: 14px; }
    pre { white-space: pre-wrap; border-radius: 14px; padding: 12px; border: 1px solid rgba(127,127,127,.25); background: rgba(0,0,0,.04); }
    .warn { margin-top: 10px; opacity: .85; font-size: 12px; line-height: 1.4; }
    .badge { position: fixed; right: 16px; bottom: 70px; z-index: 9999; padding: 8px 10px; border-radius: 12px;
             border: 1px solid rgba(127,127,127,.25); background: rgba(20,20,20,.70); color:#ddd; font-size: 12px; }
    .micBtn { position: fixed; right: 16px; bottom: 16px; z-index: 9999; padding: 12px 14px; border-radius: 14px;
              border: 1px solid rgba(127,127,127,.35); background: rgba(20,20,20,.92); color:#fff; font-size: 14px; }
  </style>
</head>

<body>
  <h1>FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆFDARç‰ˆï¼‰</h1>
  <p class="subTitle">æ¬¡ã®è¨ªå•å…ˆã«è¡Œãã¾ã§ã«è‡ªå‹•éŸ³å£°å…¥åŠ›ã€‚è»Šã‚„è‡ªè»¢è»Šç§»å‹•ä¸­ã§ã‚‚ã§ãã¾ã™ï¼</p>

  <div class="card">
    <div class="row">
      <div>
        <label>åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«æ¨å¥¨ï¼‰</label>
        <input id="client" placeholder="ä¾‹ï¼šAæ§˜ / KM ãªã©ï¼ˆå€‹äººæƒ…å ±ã¯å…¥ã‚Œãªã„é‹ç”¨æ¨å¥¨ï¼‰" />
      </div>
      <div>
        <label>æ—¥ä»˜</label>
        <input id="date" placeholder="YYYY/MM/DD" />
      </div>
    </div>

    <label>F</label>
    <textarea id="f" placeholder="Focus"></textarea>

    <label>D</label>
    <textarea id="d" placeholder="Data"></textarea>

    <label>A</label>
    <textarea id="a" placeholder="Action"></textarea>

    <label>R</label>
    <textarea id="r" placeholder="Response"></textarea>

    <div class="btnRow">
      <button class="primary" id="renderCopy">ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚³ãƒ”ãƒ¼</button>
      <button id="clearAll">å…¨æ¶ˆå»</button>
      <button id="saveLocal">ã“ã®å†…å®¹ã‚’ä¿å­˜</button>
      <button id="loadLocal">ä¿å­˜ã‚’èª­ã¿è¾¼ã¿</button>
    </div>

    <div class="out">
      <label>å‡ºåŠ›ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</label>
      <pre id="out"></pre>
    </div>

    <div class="warn">
      â€»å€‹äººæƒ…å ±ï¼ˆæ°åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ãªã©ï¼‰ã¯å…¥åŠ›ã—ãªã„é‹ç”¨ã«ã—ã¦ãã ã•ã„ã€‚<br>
      â€»éŸ³å£°å…¥åŠ›ã¯ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã‚Šç²¾åº¦ãƒ»å®‰å®šæ€§ãŒç•°ãªã‚Šã¾ã™ï¼ˆChromeæ¨å¥¨ï¼‰ã€‚
    </div>
  </div>

  <div class="badge" id="badge">å¾…æ©Ÿä¸­</div>
  <button class="micBtn" id="micBtn">ğŸ™ éŸ³å£°é–‹å§‹</button>

<script>
(() => {
  const el = {
    client: document.getElementById('client'),
    date: document.getElementById('date'),
    f: document.getElementById('f'),
    d: document.getElementById('d'),
    a: document.getElementById('a'),
    r: document.getElementById('r'),
    out: document.getElementById('out'),
    badge: document.getElementById('badge'),
    micBtn: document.getElementById('micBtn'),
    renderCopy: document.getElementById('renderCopy'),
    clearAll: document.getElementById('clearAll'),
    saveLocal: document.getElementById('saveLocal'),
    loadLocal: document.getElementById('loadLocal'),
  };

  const pad2 = (n) => String(n).padStart(2, '0');
  const today = () => {
    const d = new Date();
    return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
  };

  // ===== èª­ã¿ä¸Šã’ï¼ˆç”»é¢è¦‹ãªã„é‹ç”¨ã®æ ¸ï¼‰ =====
  const speak = (msg) => {
    try {
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const uttr = new SpeechSynthesisUtterance(msg);
      uttr.lang = 'ja-JP';
      uttr.rate = 1.05;
      uttr.pitch = 1.0;
      window.speechSynthesis.speak(uttr);
    } catch {}
  };

  // ===== ä¿å­˜ï¼ˆåˆ©ç”¨è€…ã‚­ãƒ¼å˜ä½ï¼‰=====
  const keyFor = (ini) => `fdar_saved_${String(ini || '').trim().toUpperCase()}`;
  const getInitial = () => (el.client.value || '').trim();

  const saveForInitial = (ini, data) => {
    try { localStorage.setItem(keyFor(ini), JSON.stringify(data)); } catch {}
  };
  const loadForInitial = (ini) => {
    try {
      const raw = localStorage.getItem(keyFor(ini));
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  };

  const snapshot = () => ({
    client: el.client.value.trim(),
    date: el.date.value.trim(),
    f: el.f.value,
    d: el.d.value,
    a: el.a.value,
    r: el.r.value,
    updatedAt: Date.now(),
  });

  const fillFromSaved = (saved) => {
    if (!saved) return;
    if (saved.client) el.client.value = saved.client;
    if (saved.date) el.date.value = saved.date;
    el.f.value = saved.f || '';
    el.d.value = saved.d || '';
    el.a.value = saved.a || '';
    el.r.value = saved.r || '';
  };

  // ===== å‡ºåŠ› =====
  const renderText = () => {
    const client = (el.client.value || '').trim();
    const date = (el.date.value || '').trim();
    const F = (el.f.value || '').trim();
    const D = (el.d.value || '').trim();
    const A = (el.a.value || '').trim();
    const R = (el.r.value || '').trim();

    return [
      `# FDAR`,
      date ? `\n${date}` : ``,
      client ? `\n\nã€${client}ã€‘` : ``,
      `\n\n## F\n${F || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}`,
      `\n\n## D\n${D || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}`,
      `\n\n## A\n${A || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}`,
      `\n\n## R\n${R || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}`,
      `\n`
    ].join('');
  };

  const renderAndCopy = async () => {
    const text = renderText();
    el.out.textContent = text;

    // è‡ªå‹•ä¿å­˜ï¼ˆ2å›ç›®ä»¥é™ã®â€œå…¨éƒ¨å¤‰ã‚ã‚Šãªã—â€ã®ãŸã‚ï¼‰
    const ini = getInitial();
    if (ini) saveForInitial(ini, snapshot());

    try {
      await navigator.clipboard.writeText(text);
      el.badge.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
      speak('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    } catch {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆiOSã§å¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      el.badge.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
      speak('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }
  };

  el.renderCopy.addEventListener('click', renderAndCopy);

  el.clearAll.addEventListener('click', () => {
    el.f.value = ''; el.d.value=''; el.a.value=''; el.r.value='';
    el.out.textContent = '';
    el.badge.textContent = 'ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
    speak('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  });

  el.saveLocal.addEventListener('click', () => {
    const ini = getInitial();
    if (!ini) { alert('åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    saveForInitial(ini, snapshot());
    el.badge.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
    speak('ä¿å­˜ã—ã¾ã—ãŸ');
  });

  el.loadLocal.addEventListener('click', () => {
    const ini = getInitial();
    if (!ini) { alert('åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const saved = loadForInitial(ini);
    if (!saved) { alert('ä¿å­˜ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    fillFromSaved(saved);
    el.badge.textContent = 'èª­ã¿è¾¼ã¿ã¾ã—ãŸ';
    speak('èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  });

  // ===== éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ï¼ˆçŠ¶æ…‹é·ç§»ï¼‰=====
  // æµã‚Œï¼š
  // ã€Œé–‹å§‹/ã‚¹ã‚¿ãƒ¼ãƒˆ/ã¯ã˜ã‚ã€â†’ åˆ©ç”¨è€…å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
  // åˆ©ç”¨è€…ï¼ˆä¾‹ï¼šAæ§˜ / KMï¼‰â†’ æ—¥ä»˜ã‚’ä»Šæ—¥ã« â†’ å‰å›ãƒ‡ãƒ¼ã‚¿ã‚ã‚Œã°è‡ªå‹•èª­ã¿è¾¼ã¿ â†’ Fãƒ¢ãƒ¼ãƒ‰ã¸
  // ã€ŒF/D/A/Rã€â†’ ãã®æ¬„ã«åˆ‡æ›¿
  // ã€Œç¢ºå®š/æ¬¡ã€â†’ æ¬¡ã®æ¬„ã¸ï¼ˆFâ†’Dâ†’Aâ†’Râ†’å¾…æ©Ÿï¼‰
  // ã€Œçµ‚ã‚ã‚Š/çµ‚äº†ã€â†’ æœªå…¥åŠ›ãƒã‚§ãƒƒã‚¯ â†’ ã‚³ãƒ¼ãƒ‰åŒ–ï¼†ã‚³ãƒ”ãƒ¼ â†’ å¾…æ©Ÿ
  // ã€Œå…¨éƒ¨å¤‰ã‚ã‚Šãªã—ã€â†’ å‰å›ãƒ‡ãƒ¼ã‚¿ã‚’ä»Šæ—¥ã®æ—¥ä»˜ã§å‡ºåŠ›ï¼†ã‚³ãƒ”ãƒ¼

  const MODE = { IDLE:'idle', NAME:'name', F:'f', D:'d', A:'a', R:'r' };
  let mode = MODE.IDLE;

  const setMode = (m) => {
    mode = m;
    const labelMap = {
      [MODE.IDLE]: 'å¾…æ©Ÿä¸­',
      [MODE.NAME]: 'å…¥åŠ›ï¼šåˆ©ç”¨è€…åï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ï¼‰',
      [MODE.F]: 'å…¥åŠ›ï¼šF',
      [MODE.D]: 'å…¥åŠ›ï¼šD',
      [MODE.A]: 'å…¥åŠ›ï¼šA',
      [MODE.R]: 'å…¥åŠ›ï¼šR',
    };
    const label = labelMap[m] || 'å¾…æ©Ÿä¸­';
    el.badge.textContent = label;
    speak(label);
  };
  setMode(MODE.IDLE);

  const norm = (s) => (s || '')
    .trim()
    .replace(/[ï¼!ã€‚ï¼\.]/g,'')
    .replace(/[ã€ï¼Œ]/g,' ')
    .replace(/\s+/g,' ')
    .toLowerCase();

  const includesAny = (t, arr) => arr.some(w => t.includes(w));

  const isStart = (t) => includesAny(t, ['é–‹å§‹','ã‚¹ã‚¿ãƒ¼ãƒˆ','ã¯ã˜ã‚','ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹','é–‹å§‹ã™ã‚‹']);
  const isEnd   = (t) => includesAny(t, ['çµ‚ã‚ã‚Š','ãŠã‚ã‚Š','çµ‚äº†','ã—ã‚…ã†ã‚Šã‚‡ã†','å®Œäº†']);
  const isSame  = (t) => includesAny(t, ['å…¨éƒ¨å¤‰ã‚ã‚Šãªã—','ãœã‚“ã¶ã‹ã‚ã‚Šãªã—','å…¨éƒ¨åŒã˜','å‰å›ã¨åŒã˜','å…¨ã¦åŒã˜','å¤‰ã‚ã‚Šãªã—']);

  const wantF = (t) => includesAny(t, ['f','ãˆãµ','ã‚¨ãƒ•','ãµã‰ãƒ¼ã‹ã™','ãƒ•ã‚©ãƒ¼ã‚«ã‚¹']);
  const wantD = (t) => includesAny(t, ['d','ã§ãƒ','ãƒ‡ã‚£','ã§ãƒ¼ãŸ','ãƒ‡ãƒ¼ã‚¿']);
  const wantA = (t) => includesAny(t, ['a','ãˆãƒ¼','ã‚¨ãƒ¼','ã‚ãã—ã‚‡ã‚“','ã‚¢ã‚¯ã‚·ãƒ§ãƒ³']);
  const wantR = (t) => includesAny(t, ['r','ã‚ãƒ¼ã‚‹','ã‚¢ãƒ¼ãƒ«','ã‚Œã™ã½ã‚“ã™','ãƒ¬ã‚¹ãƒãƒ³ã‚¹']);

  const isNext = (t) => includesAny(t, ['æ¬¡','ã¤ã','ç¢ºå®š','ã‹ãã¦ã„','ok','ã‚ªãƒƒã‚±ãƒ¼','äº†è§£','ã‚Šã‚‡ã†ã‹ã„']);

  const nextMode = (m) => {
    if (m === MODE.F) return MODE.D;
    if (m === MODE.D) return MODE.A;
    if (m === MODE.A) return MODE.R;
    if (m === MODE.R) return MODE.IDLE;
    return m;
  };

  const append = (targetEl, rawText) => {
    const text = (rawText || '').trim();
    if (!text) return;
    // ã‚³ãƒãƒ³ãƒ‰æ··å…¥ã‚’æ¸›ã‚‰ã™ï¼ˆä¾‹ï¼šã€Œç¢ºå®šã€ã ã‘è¨€ã£ãŸæ™‚ãªã©ï¼‰
    if (['æ¬¡','ã¤ã','ç¢ºå®š','ã‹ãã¦ã„','ok','ã‚ªãƒƒã‚±ãƒ¼','çµ‚ã‚ã‚Š','ãŠã‚ã‚Š','çµ‚äº†','ã—ã‚…ã†ã‚Šã‚‡ã†'].includes(text)) return;

    if (targetEl.value && !targetEl.value.endsWith('\n')) targetEl.value += '\n';
    targetEl.value += text;
  };

  const applySameAsSaved = () => {
    const ini = getInitial();
    if (!ini) { speak('åˆ©ç”¨è€…åãŒæœªå…¥åŠ›ã§ã™'); return; }
    const saved = loadForInitial(ini);
    if (!saved) { speak('ä¿å­˜ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

    // ä»Šæ—¥ã®æ—¥ä»˜ã§å‡ºåŠ›ï¼ˆä¸­èº«ã¯ä¿å­˜ã®ã¾ã¾ï¼‰
    el.date.value = today();
    fillFromSaved(saved);
    el.date.value = today();
    renderAndCopy();
    setMode(MODE.IDLE);
  };

  const onNameSpoken = (raw) => {
    const name = (raw || '').trim();
    if (!name) return;
    el.client.value = name;
    el.date.value = today();

    const saved = loadForInitial(name);
    if (saved) fillFromSaved(saved);

    setMode(MODE.F);
  };

  const handleText = (raw) => {
    const t = norm(raw);

    if (!t) return;

    if (isStart(t)) { setMode(MODE.NAME); return; }
    if (isSame(t))  { applySameAsSaved(); return; }

    if (isEnd(t)) {
      const missing = [];
      if (!el.f.value.trim()) missing.push('F');
      if (!el.d.value.trim()) missing.push('D');
      if (!el.a.value.trim()) missing.push('A');
      if (!el.r.value.trim()) missing.push('R');

      if (missing.length) {
        const msg = `${missing.join('ãƒ»')}ãŒæœªå…¥åŠ›ã§ã™`;
        el.badge.textContent = msg;
        speak(msg);
        return;
      }

      renderAndCopy();
      setMode(MODE.IDLE);
      return;
    }

    // æ‰‹å‹•ã§æ¬„åˆ‡æ›¿
    if (wantF(t)) { setMode(MODE.F); return; }
    if (wantD(t)) { setMode(MODE.D); return; }
    if (wantA(t)) { setMode(MODE.A); return; }
    if (wantR(t)) { setMode(MODE.R); return; }

    // NAMEãƒ¢ãƒ¼ãƒ‰ï¼šã“ã“ã§åˆ©ç”¨è€…å…¥åŠ›
    if (mode === MODE.NAME) { onNameSpoken(raw); return; }

    // è¿½è¨˜ãƒ¢ãƒ¼ãƒ‰
    if (mode === MODE.F) { append(el.f, raw); if (isNext(t)) setMode(nextMode(mode)); return; }
    if (mode === MODE.D) { append(el.d, raw); if (isNext(t)) setMode(nextMode(mode)); return; }
    if (mode === MODE.A) { append(el.a, raw); if (isNext(t)) setMode(nextMode(mode)); return; }
    if (mode === MODE.R) { append(el.r, raw); if (isNext(t)) setMode(nextMode(mode)); return; }

    // IDLEã¯ä½•ã‚‚ã—ãªã„ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
  };

  // ===== éŸ³å£°èªè­˜ =====
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let listening = false;

  const startRec = () => {
    if (!SR) { alert('ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èªè­˜ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆChromeæ¨å¥¨ï¼‰'); return; }
    rec = new SR();
    rec.lang = 'ja-JP';
    rec.interimResults = false;
    rec.continuous = true;

    rec.onresult = (e) => {
      const last = e.results[e.results.length - 1];
      const text = last && last[0] ? last[0].transcript : '';
      if (text) handleText(text);
    };

    rec.onend = () => {
      // iOSã§æ­¢ã¾ã‚Šã‚„ã™ã„ã®ã§ã€listenä¸­ãªã‚‰å†é–‹ã‚’è©¦ã™
      if (listening) {
        try { rec.start(); } catch {}
      }
    };

    try { rec.start(); } catch {}
  };

  const stopRec = () => {
    try { if (rec) rec.stop(); } catch {}
    rec = null;
  };

  el.micBtn.addEventListener('click', () => {
    listening = !listening;
    el.micBtn.textContent = listening ? 'â–  éŸ³å£°åœæ­¢' : 'ğŸ™ éŸ³å£°é–‹å§‹';
    if (listening) { startRec(); speak('éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã—ãŸ'); }
    else { stopRec(); speak('éŸ³å£°å…¥åŠ›ã‚’åœæ­¢ã—ã¾ã—ãŸ'); }
  });

  // åˆæœŸæ—¥ä»˜
  el.date.value = today();
})();
</script>
</body>
</html>
