<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <style>
    :root { color-scheme: light dark; }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 18px;
      max-width: 860px;
      line-height: 1.45;
    }
    h1{
      font-size: 22px;
      margin: 0 0 8px;
      letter-spacing: .2px;
    }
    .sub{
      margin: 0 0 14px;
      opacity: .8;
      font-size: 13px;
    }
    .card{
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      padding: 14px;
      background: rgba(127,127,127,.10);
    }
    .modeRow{
      display:flex;
      gap:10px;
      margin-bottom: 12px;
    }
    .modeBtn{
      flex:1;
      text-align:left;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.10);
      cursor:pointer;
      user-select:none;
    }
    .modeBtn.active{
      background: rgba(100,160,255,.18);
      border-color: rgba(100,160,255,.45);
    }
    .modeTitle{ font-weight: 700; margin-bottom: 4px; }
    .modeDesc{ font-size: 12px; opacity: .85; }

    label{
      display:block;
      font-size: 13px;
      opacity: .9;
      margin: 14px 0 6px;
    }
    input, textarea{
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      display:block;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.12);
      color: inherit;
      outline: none;
    }
    input{
      text-align: center;
      font-size: 18px;
      letter-spacing: .5px;
    }
    textarea{
      height: 86px;
      resize: vertical;
      line-height: 1.35;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    button{
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.10);
      color: inherit;
      padding: 12px 14px;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
    }
    button.primary{
      background: rgba(100,160,255,.22);
      border-color: rgba(100,160,255,.45);
      font-weight: 700;
    }
    .badge{
      display:inline-block;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.12);
      font-size: 14px;
      min-width: 86px;
      text-align:center;
    }

    .help{
      margin-top: 12px;
      font-size: 13px;
      opacity: .85;
      line-height: 1.55;
    }
    .help b{ opacity: 1; }

    .outTitle{
      margin: 16px 0 8px;
      font-size: 14px;
      opacity: .9;
      font-weight: 700;
    }
    pre{
      white-space: pre-wrap;
      word-break: break-word;
      border-radius: 16px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.10);
      padding: 14px;
      margin: 0 0 18px;
      font-size: 14px;
      line-height: 1.45;
    }

    /* å³ä¸‹ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ */
    .micBtn{
      position: fixed;
      right: 14px;
      bottom: 18px;
      z-index: 9999;
      pointer-events: auto;
      border-radius: 999px;
      padding: 14px 16px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(0,0,0,.80);
      color: #fff;
      font-size: 15px;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .micBtn.listening{
      background: rgba(170,0,0,.80);
    }
  </style>
</head>
<body>
  <h1>FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
  <p class="sub">éŸ³å£°ã§ã€Œé–‹å§‹ã€â†’ã€ŒAæ§˜ã€â†’ã€ŒFã€â€¦ã€â†’â€¦â†’ã€Œçµ‚äº†ã€ã€‚ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</p>

  <div class="card">
    <div class="modeRow">
      <div id="btnFDAR" class="modeBtn active" role="button" tabindex="0">
        <div class="modeTitle">FDARç‰ˆ</div>
        <div class="modeDesc">åˆ©ç”¨è€…â†’ï¼ˆF/D/A/Rï¼‰â†’æ–‡ç« ç”Ÿæˆâ†’ã‚³ãƒ”ãƒ¼</div>
      </div>
      <div id="btnSOAP" class="modeBtn" role="button" tabindex="0">
        <div class="modeTitle">SOAPç‰ˆ</div>
        <div class="modeDesc">åˆ©ç”¨è€…â†’ï¼ˆS/O/A/Pï¼‰â†’æ–‡ç« ç”Ÿæˆâ†’ã‚³ãƒ”ãƒ¼</div>
      </div>
    </div>

    <label for="client">åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«æ¨å¥¨ï¼‰</label>
    <input id="client" placeholder="ä¾‹ï¼šAæ§˜ / KM ãªã©ï¼ˆå€‹äººãŒç‰¹å®šã§ãã‚‹æƒ…å ±ã¯å…¥ã‚Œãªã„ï¼‰" />

    <label for="date">æ—¥ä»˜ï¼ˆè‡ªå‹•ï¼‰</label>
    <input id="date" />

    <!-- FDAR fields -->
    <div id="panelFDAR">
      <label for="f">Fï¼ˆFocusï¼‰</label>
      <textarea id="f" placeholder="ä¾‹ï¼šæœ¬æ—¥ã®ç„¦ç‚¹ã€èª²é¡Œã€ä¸»è¨´ãªã©"></textarea>

      <label for="d">Dï¼ˆDataï¼‰</label>
      <textarea id="d" placeholder="ä¾‹ï¼šãƒã‚¤ã‚¿ãƒ«ã€æ‰€è¦‹ã€å‹•ä½œã€è¦³å¯Ÿãªã©"></textarea>

      <label for="a">Aï¼ˆActionï¼‰</label>
      <textarea id="a" placeholder="ä¾‹ï¼šå®Ÿæ–½å†…å®¹ã€ä»‹å…¥ã€æŒ‡å°ãªã©"></textarea>

      <label for="r">Rï¼ˆResponseï¼‰</label>
      <textarea id="r" placeholder="ä¾‹ï¼šåå¿œã€å¤‰åŒ–ã€è©•ä¾¡ãªã©"></textarea>
    </div>

    <!-- SOAP fields -->
    <div id="panelSOAP" style="display:none;">
      <label for="s">Sï¼ˆSubjectiveï¼‰</label>
      <textarea id="s" placeholder="ä¾‹ï¼šä¸»è¦³æƒ…å ±ã€è¨´ãˆãªã©"></textarea>

      <label for="o">Oï¼ˆObjectiveï¼‰</label>
      <textarea id="o" placeholder="ä¾‹ï¼šå®¢è¦³æ‰€è¦‹ã€ãƒã‚¤ã‚¿ãƒ«ã€å‹•ä½œãªã©"></textarea>

      <label for="a2">Aï¼ˆAssessmentï¼‰</label>
      <textarea id="a2" placeholder="ä¾‹ï¼šè©•ä¾¡ã€è§£é‡ˆãªã©"></textarea>

      <label for="p">Pï¼ˆPlanï¼‰</label>
      <textarea id="p" placeholder="ä¾‹ï¼šæ–¹é‡ã€æ¬¡å›ã€æŒ‡å°ãªã©"></textarea>
    </div>

    <div class="btnRow">
      <button id="buildCopy" class="primary">ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚³ãƒ”ãƒ¼</button>
      <button id="clearAll">å…¨æ¶ˆå»</button>
      <span id="status" class="badge">å¾…æ©Ÿä¸­</span>
    </div>

    <div class="help">
      <div><b>éŸ³å£°ãƒ«ãƒ¼ãƒ«</b></div>
      <div>1) å³ä¸‹ã® <b>éŸ³å£°é–‹å§‹</b> â†’ ã™ãã«ã€Œ<b>é–‹å§‹</b>ã€</div>
      <div>2) ã€Œ<b>Aæ§˜</b>ã€ã®ã‚ˆã†ã«åˆ©ç”¨è€…ã‚’è¨€ã†ï¼ˆä»¥å¾Œã€ãã®åˆ©ç”¨è€…ã®ã‚«ãƒ«ãƒ†ã¨ã—ã¦å…¥åŠ›ï¼‰</div>
      <div>3) ã€Œ<b>Fã€â—¯â—¯</b>ã€ã€Œ<b>Dã€â—¯â—¯</b>ã€ã€Œ<b>Aã€â—¯â—¯</b>ã€ã€Œ<b>Rã€â—¯â—¯</b>ã€ã§è‡ªå‹•æŒ¯æ›¿ï¼ˆSOAPã¯ S/O/A/Pï¼‰</div>
      <div>4) ã€Œ<b>çµ‚äº†</b>ã€ã§å…¥åŠ›å®Œäº†ï¼ˆç”Ÿæˆâ†’ã‚³ãƒ”ãƒ¼ï¼‰</div>
      <div style="margin-top:6px; opacity:.85;">â€»ã€Œã‚¨ãƒ•ã€ã€Œãƒ‡ã‚£ãƒ¼ã€ãªã©ã®è¨€ã„æ–¹ã‚‚å¸åã—ã¾ã™ã€‚é …ç›®ã‚’è¨€ã‚ãšã«è©±ã—ãŸå ´åˆã¯ã€æœ€å¾Œã«æŒ‡å®šã—ãŸé …ç›®ã¸å…¥ã‚Šã¾ã™ã€‚</div>
    </div>

    <div class="outTitle">å‡ºåŠ›ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</div>
    <pre id="out"></pre>
  </div>

  <button id="mic" class="micBtn" type="button">ğŸ™ï¸ éŸ³å£°é–‹å§‹</button>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  // ====== æ—¥ä»˜ï¼ˆè‡ªå‹•ï¼‰ ======
  function pad2(n){ return String(n).padStart(2,'0'); }
  function todayYMD(slash=true){
    const d = new Date();
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    return slash ? `${y}/${m}/${dd}` : `${y}-${m}-${dd}`;
  }
  $('date').value = todayYMD(true);

  // ====== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ======
  let mode = 'FDAR'; // FDAR | SOAP
  function setMode(m){
    mode = m;
    $('btnFDAR').classList.toggle('active', mode==='FDAR');
    $('btnSOAP').classList.toggle('active', mode==='SOAP');
    $('panelFDAR').style.display = (mode==='FDAR') ? '' : 'none';
    $('panelSOAP').style.display = (mode==='SOAP') ? '' : 'none';
    render();
  }
  $('btnFDAR').addEventListener('click', ()=>setMode('FDAR'));
  $('btnSOAP').addEventListener('click', ()=>setMode('SOAP'));

  // ====== çŠ¶æ…‹ï¼ˆéŸ³å£°å…¥åŠ›ã®æ ¸ï¼‰ ======
  let listening = false;
  let activeClient = '';            // "Aæ§˜" ç­‰
  let lastSection = null;           // 'f','d','a','r' / 's','o','a2','p'
  let rec = null;

  // ã€Œé–‹å§‹ã€ã€Œçµ‚äº†ã€ãƒ¯ãƒ¼ãƒ‰
  const START_WORDS = ['é–‹å§‹','ã¯ã˜ã‚','ã‚¹ã‚¿ãƒ¼ãƒˆ','start','START'];
  const END_WORDS   = ['çµ‚äº†','çµ‚ã‚ã‚Š','ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥','finish','FINISH','stop','STOP'];

  // ç™ºè©±ã®ã€Œã‚¨ãƒ•/ãƒ‡ã‚£ãƒ¼/ã‚¨ãƒ¼/ã‚¢ãƒ¼ãƒ«ã€ç­‰ã‚’å¸å
  const JP_TO_SECTION_FDAR = [
    ['F','f'], ['ã‚¨ãƒ•','f'], ['ãˆãµ','f'],
    ['D','d'], ['ãƒ‡ã‚£ãƒ¼','d'], ['ã§ãƒãƒ¼','d'], ['ã§ãƒ','d'], ['ãƒ‡ã‚£','d'],
    ['A','a'], ['ã‚¨ãƒ¼','a'], ['ãˆãƒ¼','a'], ['ã‚¨ã‚¤','a'], ['ãˆã„','a'],
    ['R','r'], ['ã‚¢ãƒ¼ãƒ«','r'], ['ã‚ãƒ¼ã‚‹','r'],
  ];
  const JP_TO_SECTION_SOAP = [
    ['S','s'], ['ã‚¨ã‚¹','s'], ['ãˆã™','s'],
    ['O','o'], ['ã‚ªãƒ¼','o'], ['ãŠãƒ¼','o'],
    ['A','a2'], ['ã‚¨ãƒ¼','a2'], ['ãˆãƒ¼','a2'], ['ã‚¨ã‚¤','a2'], ['ãˆã„','a2'],
    ['P','p'], ['ãƒ”ãƒ¼','p'], ['ã´ãƒ¼','p'],
  ];

  function normalizeText(t){
    return (t||'')
      .replace(/\s+/g,' ')
      .replace(/ã€€/g,' ')
      .trim();
  }
  function isStartWord(t){
    return START_WORDS.some(w => t === w);
  }
  function isEndWord(t){
    return END_WORDS.some(w => t === w);
  }

  // åˆ©ç”¨è€…ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«: "Aæ§˜" / "KM" / "K M" / "ï¼¡æ§˜"
  function parseClient(t){
    const x = t.replace(/\s+/g,'').replace(/ã•ã¾$/,'æ§˜');
    // 1-4æ–‡å­—ã®è‹±å­—ï¼ˆå…¨è§’å«ã‚€ï¼‰ï¼‹ä»»æ„ã®æ§˜
    const m = x.match(/^([A-Zï¼¡-ï¼º]{1,4})æ§˜?$/);
    if(!m) return null;
    const raw = m[1].replace(/[ï¼¡-ï¼º]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    return raw + 'æ§˜';
  }

  function mapSectionToken(token){
    const map = (mode==='FDAR') ? JP_TO_SECTION_FDAR : JP_TO_SECTION_SOAP;
    for(const [k,v] of map){
      if(token === k) return v;
    }
    return null;
  }

  // "Fã€â—¯â—¯" / "ã‚¨ãƒ•ã€â—¯â—¯" / "D: â—¯â—¯" / "P ã€‡ã€‡" ãªã©
  function parseSectionLine(t){
    // å…ˆé ­ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆå…¨è§’ã‚«ãƒ³ãƒ/å¥ç‚¹/ã‚³ãƒ­ãƒ³ã«ã‚‚å¯¾å¿œï¼‰
    const m = t.match(/^(.{1,6})[ã€,:\uFF1A]\s*(.+)$/);
    if(m){
      const head = normalizeText(m[1]);
      const body = normalizeText(m[2]);
      const sec = mapSectionToken(head);
      if(sec && body) return { sec, body };
    }
    // "F ã€‡ã€‡" å½¢å¼ï¼ˆåŒºåˆ‡ã‚ŠãŒã‚¹ãƒšãƒ¼ã‚¹ã®ã¿ï¼‰
    const m2 = t.match(/^(.{1,6})\s+(.+)$/);
    if(m2){
      const head = normalizeText(m2[1]);
      const body = normalizeText(m2[2]);
      const sec = mapSectionToken(head);
      if(sec && body) return { sec, body };
    }
    // "F" ã ã‘ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡æ›¿ï¼‰
    const secOnly = mapSectionToken(t);
    if(secOnly) return { sec: secOnly, body: '' };
    return null;
  }

  function appendToField(fieldId, text){
    const el = $(fieldId);
    if(!el) return;
    if(!text) return;
    const cur = (el.value || '').trimEnd();
    el.value = cur ? (cur + '\n' + text) : text;
    lastSection = fieldId;
    render();
  }

  function setClient(name){
    activeClient = name;
    $('client').value = name;
    render();
  }

  function firstSectionId(){
    return (mode==='FDAR') ? 'f' : 's';
  }

  // ã€Œé …ç›®ã‚’è¨€ã‚ãšã«è©±ã—ãŸã€å ´åˆã®æŠ•å…¥å…ˆ
  function defaultTarget(){
    return lastSection || firstSectionId();
  }

  // ====== å‡ºåŠ›ç”Ÿæˆ ======
  function buildText(){
    const dateISO = todayYMD(false);
    const client = normalizeText($('client').value);
    if(mode==='FDAR'){
      const f = normalizeText($('f').value);
      const d = normalizeText($('d').value);
      const a = normalizeText($('a').value);
      const r = normalizeText($('r').value);
      return [
        dateISO,
        client ? `åˆ©ç”¨è€…ï¼š${client}` : '',
        f ? `Fï¼š${f}` : 'Fï¼š',
        d ? `Dï¼š${d}` : 'Dï¼š',
        a ? `Aï¼š${a}` : 'Aï¼š',
        r ? `Rï¼š${r}` : 'Rï¼š',
      ].filter(Boolean).join('\n');
    } else {
      const s = normalizeText($('s').value);
      const o = normalizeText($('o').value);
      const a2 = normalizeText($('a2').value);
      const p = normalizeText($('p').value);
      return [
        dateISO,
        client ? `åˆ©ç”¨è€…ï¼š${client}` : '',
        s ? `Sï¼š${s}` : 'Sï¼š',
        o ? `Oï¼š${o}` : 'Oï¼š',
        a2 ? `Aï¼š${a2}` : 'Aï¼š',
        p ? `Pï¼š${p}` : 'Pï¼š',
      ].filter(Boolean).join('\n');
    }
  }

  function render(){
    $('out').textContent = buildText();
  }
  render();

  // ====== ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ ======
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      $('status').textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
      setTimeout(()=> $('status').textContent = listening ? 'éŸ³å£°å…¥åŠ›ä¸­' : 'å¾…æ©Ÿä¸­', 900);
    }catch(_){
      // iOSãªã©ã§å¤±æ•—ã™ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      $('status').textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
      setTimeout(()=> $('status').textContent = listening ? 'éŸ³å£°å…¥åŠ›ä¸­' : 'å¾…æ©Ÿä¸­', 900);
    }
  }

  $('buildCopy').addEventListener('click', async ()=>{
    render();
    await copyText($('out').textContent);
  });

  $('clearAll').addEventListener('click', ()=>{
    $('client').value = '';
    activeClient = '';
    lastSection = null;
    if(mode==='FDAR'){
      $('f').value=''; $('d').value=''; $('a').value=''; $('r').value='';
    }else{
      $('s').value=''; $('o').value=''; $('a2').value=''; $('p').value='';
    }
    $('status').textContent = 'å¾…æ©Ÿä¸­';
    render();
  });

  // ====== éŸ³å£°èªè­˜ ======
  function getSR(){
    return window.SpeechRecognition || window.webkitSpeechRecognition || null;
  }

  function ensureRec(){
    if(rec) return rec;
    const SR = getSR();
    if(!SR) return null;

    rec = new SR();
    rec.lang = 'ja-JP';
    rec.continuous = true;
    rec.interimResults = false;

    rec.onresult = (e)=>{
      // æœ€æ–°çµæœã®ã¿æ‹¾ã†
      const res = e.results[e.results.length - 1];
      if(!res || !res[0]) return;
      const raw = res[0].transcript;
      const t = normalizeText(raw);

      if(!t) return;

      // é–‹å§‹/çµ‚äº†
      if(isStartWord(t)){
        listening = true;
        $('mic').classList.add('listening');
        $('mic').textContent = 'â›” éŸ³å£°åœæ­¢';
        $('status').textContent = 'éŸ³å£°å…¥åŠ›ä¸­';
        lastSection = firstSectionId(); // é–‹å§‹ã—ãŸã‚‰æœ€åˆã®é …ç›®ã«ã‚»ãƒƒãƒˆ
        return;
      }
      if(isEndWord(t)){
        // çµ‚äº†ã§æ­¢ã‚ã¦ã‚³ãƒ”ãƒ¼ã¾ã§
        stopListening();
        render();
        copyText($('out').textContent);
        return;
      }

      // åˆ©ç”¨è€…ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«
      const c = parseClient(t);
      if(c){
        setClient(c);
        // åˆ©ç”¨è€…ã‚’è¨€ã£ãŸã‚‰ã€æ¬¡ã¯æœ€åˆã®é …ç›®ã¸
        lastSection = firstSectionId();
        return;
      }

      // é …ç›®è¡Œ
      const secLine = parseSectionLine(t);
      if(secLine){
        if(secLine.body){
          appendToField(secLine.sec, secLine.body);
        }else{
          // "F" ã ã‘ã§åˆ‡æ›¿
          lastSection = secLine.sec;
          $('status').textContent = 'éŸ³å£°å…¥åŠ›ä¸­';
        }
        return;
      }

      // ä½•ã‚‚æŒ‡å®šãŒãªã‘ã‚Œã°ã€Œæœ€å¾Œã®é …ç›®ã€ã¸å…¥ã‚Œã‚‹
      appendToField(defaultTarget(), t);
    };

    rec.onerror = (_e)=>{
      $('status').textContent = 'éŸ³å£°ã‚¨ãƒ©ãƒ¼';
      setTimeout(()=> $('status').textContent = listening ? 'éŸ³å£°å…¥åŠ›ä¸­' : 'å¾…æ©Ÿä¸­', 1200);
    };

    rec.onend = ()=>{
      // iOSç­‰ã§å‹æ‰‹ã«åˆ‡ã‚ŒãŸæ™‚ã€å…¥åŠ›ä¸­ãªã‚‰å†é–‹
      if(listening){
        try{ rec.start(); }catch(_){}
      }
    };

    return rec;
  }

  function startListening(){
    const SR = getSR();
    if(!SR){
      $('status').textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œ';
      return;
    }
    ensureRec();
    try{
      // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç›´å¾Œã« start ã™ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ç´ã¥ã‘ã‚‹ï¼‰
      rec.start();
      $('status').textContent = 'å¾…æ©Ÿä¸­';
      // ã“ã“ã§ã¯ã€Œé–‹å§‹ã€ã‚’å¾…ã¤ï¼ˆèª¤å…¥åŠ›é˜²æ­¢ï¼‰
    }catch(_){}
  }

  function stopListening(){
    listening = false;
    $('mic').classList.remove('listening');
    $('mic').textContent = 'ğŸ™ï¸ éŸ³å£°é–‹å§‹';
    $('status').textContent = 'å¾…æ©Ÿä¸­';
    try{ rec && rec.stop(); }catch(_){}
  }

  const micHandler = ()=>{
  // ã€Œèµ·å‹•ã€â†’ã€Œé–‹å§‹ã€å¾…ã¡ ã‹ã€å…¥åŠ›ä¸­â†’åœæ­¢
  if(listening){
    stopListening();
    return;
  }
  startListening();
};

// iPhoneå¯¾ç­–ï¼šclick ã ã‘ã ã¨æ‹¾ãˆãªã„äº‹ãŒã‚ã‚‹
$('mic').addEventListener('pointerdown', micHandler);
$('mic').addEventListener('touchstart', micHandler, { passive: true });
$('mic').addEventListener('click', micHandler);    // ã€Œèµ·å‹•ã€â†’ã€Œé–‹å§‹ã€å¾…ã¡ ã‹ã€å…¥åŠ›ä¸­â†’åœæ­¢
    if(listening){
      stopListening();
      return;
    }
    startListening();
  });

  // å…¥åŠ›ãŒæ‰‹æ‰“ã¡ã§ã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  ['client','f','d','a','r','s','o','a2','p'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener('input', render);
  });

})();
</script>
</body>
</html>
