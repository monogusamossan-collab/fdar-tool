<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <style>
    :root { color-scheme: light dark; }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 18px;
      max-width: 860px;
      line-height: 1.45;
    }
    h1{ font-size: 22px; margin: 0 0 8px; letter-spacing: .2px; }
    .sub{ margin: 0 0 14px; opacity: .8; font-size: 13px; }
    .card{
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      padding: 14px;
      background: rgba(127,127,127,.10);
    }
    .modeRow{ display:flex; gap:10px; margin-bottom: 12px; }
    .modeBtn{
      flex:1; text-align:left; padding:14px 14px; border-radius:16px;
      border:1px solid rgba(127,127,127,.35); background: rgba(127,127,127,.10);
      cursor:pointer; user-select:none;
    }
    .modeBtn.active{ background: rgba(100,160,255,.18); border-color: rgba(100,160,255,.45); }
    .modeTitle{ font-weight: 700; margin-bottom: 4px; }
    .modeDesc{ font-size: 12px; opacity: .85; }

    label{ display:block; font-size: 13px; opacity: .9; margin: 14px 0 6px; }
    input, textarea{
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      display:block;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.12);
      color: inherit;
      outline: none;
    }
    input{
      text-align: center;
      font-size: 18px;
      letter-spacing: .5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    textarea{ height: 86px; resize: vertical; line-height: 1.35; }

    .btnRow{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 14px; align-items:center; }
    button{
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.10);
      color: inherit;
      padding: 12px 14px;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
    }
    button.primary{
      background: rgba(100,160,255,.22);
      border-color: rgba(100,160,255,.45);
      font-weight: 700;
    }
    .badge{
      display:inline-block;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.12);
      font-size: 14px;
      min-width: 86px;
      text-align:center;
    }

    .help{ margin-top: 12px; font-size: 13px; opacity: .85; line-height: 1.55; }
    .help b{ opacity: 1; }

    .outTitle{ margin: 16px 0 8px; font-size: 14px; opacity: .9; font-weight: 700; }
    pre{
      white-space: pre-wrap;
      word-break: break-word;
      border-radius: 16px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.10);
      padding: 14px;
      margin: 0 0 18px;
      font-size: 14px;
      line-height: 1.45;
    }

    /* å³ä¸‹ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ */
    .micBtn{
      position: fixed;
      right: 14px;
      bottom: 18px;
      z-index: 9999;
      pointer-events: auto;
      border-radius: 999px;
      padding: 14px 16px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(0,0,0,.80);
      color: #fff;
      font-size: 15px;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .micBtn.listening{ background: rgba(170,0,0,.80); }
  </style>
</head>
<body>
  <h1>FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
  <p class="sub">éŸ³å£°ã§ã€Œé–‹å§‹ã€â†’ã€ŒAæ§˜ã€â†’ã€ŒFã€â€¦ã€â†’â€¦â†’ã€Œçµ‚äº†ã€ã€‚ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</p>

  <div class="card">
    <div class="modeRow">
      <div id="btnFDAR" class="modeBtn active" role="button" tabindex="0">
        <div class="modeTitle">FDARç‰ˆ</div>
        <div class="modeDesc">åˆ©ç”¨è€…â†’ï¼ˆF/D/A/Rï¼‰â†’æ–‡ç« ç”Ÿæˆâ†’ã‚³ãƒ”ãƒ¼</div>
      </div>
      <div id="btnSOAP" class="modeBtn" role="button" tabindex="0">
        <div class="modeTitle">SOAPç‰ˆ</div>
        <div class="modeDesc">åˆ©ç”¨è€…â†’ï¼ˆS/O/A/Pï¼‰â†’æ–‡ç« ç”Ÿæˆâ†’ã‚³ãƒ”ãƒ¼</div>
      </div>
    </div>

    <label for="client">åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«æ¨å¥¨ï¼‰</label>
    <input id="client" placeholder="ä¾‹ï¼šAæ§˜ / KM ãªã©ï¼ˆå€‹äººãŒç‰¹å®šã§ãã‚‹æƒ…å ±ã¯å…¥ã‚Œãªã„ï¼‰" />

    <label for="date">æ—¥ä»˜ï¼ˆè‡ªå‹•ï¼‰</label>
    <input id="date" />

    <!-- FDAR fields -->
    <div id="panelFDAR">
      <label for="f">Fï¼ˆFocusï¼‰</label>
      <textarea id="f" placeholder="ä¾‹ï¼šæœ¬æ—¥ã®ç„¦ç‚¹ã€èª²é¡Œã€ä¸»è¨´ãªã©"></textarea>

      <label for="d">Dï¼ˆDataï¼‰</label>
      <textarea id="d" placeholder="ä¾‹ï¼šãƒã‚¤ã‚¿ãƒ«ã€æ‰€è¦‹ã€å‹•ä½œã€è¦³å¯Ÿãªã©"></textarea>

      <label for="a">Aï¼ˆActionï¼‰</label>
      <textarea id="a" placeholder="ä¾‹ï¼šå®Ÿæ–½å†…å®¹ã€ä»‹å…¥ã€æŒ‡å°ãªã©"></textarea>

      <label for="r">Rï¼ˆResponseï¼‰</label>
      <textarea id="r" placeholder="ä¾‹ï¼šåå¿œã€å¤‰åŒ–ã€è©•ä¾¡ãªã©"></textarea>
    </div>

    <!-- SOAP fields -->
    <div id="panelSOAP" style="display:none;">
      <label for="s">Sï¼ˆSubjectiveï¼‰</label>
      <textarea id="s" placeholder="ä¾‹ï¼šä¸»è¦³æƒ…å ±ã€è¨´ãˆãªã©"></textarea>

      <label for="o">Oï¼ˆObjectiveï¼‰</label>
      <textarea id="o" placeholder="ä¾‹ï¼šå®¢è¦³æ‰€è¦‹ã€ãƒã‚¤ã‚¿ãƒ«ã€å‹•ä½œãªã©"></textarea>

      <label for="a2">Aï¼ˆAssessmentï¼‰</label>
      <textarea id="a2" placeholder="ä¾‹ï¼šè©•ä¾¡ã€è§£é‡ˆãªã©"></textarea>

      <label for="p">Pï¼ˆPlanï¼‰</label>
      <textarea id="p" placeholder="ä¾‹ï¼šæ–¹é‡ã€æ¬¡å›ã€æŒ‡å°ãªã©"></textarea>
    </div>

    <div class="btnRow">
      <button id="buildCopy" class="primary">ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚³ãƒ”ãƒ¼</button>
      <button id="clearAll">å…¨æ¶ˆå»</button>
      <span id="status" class="badge">å¾…æ©Ÿä¸­</span>
    </div>

    <div class="help">
      <div><b>éŸ³å£°ãƒ«ãƒ¼ãƒ«</b></div>
      <div>1) å³ä¸‹ã® <b>éŸ³å£°é–‹å§‹</b> â†’ ã™ãã«ã€Œ<b>é–‹å§‹</b>ã€</div>
      <div>2) ã€Œ<b>Aæ§˜</b>ã€ã®ã‚ˆã†ã«åˆ©ç”¨è€…ã‚’è¨€ã†</div>
      <div>3) ã€Œ<b>Fã€â—¯â—¯</b>ã€ã€Œ<b>Dã€â—¯â—¯</b>ã€ã€Œ<b>Aã€â—¯â—¯</b>ã€ã€Œ<b>Rã€â—¯â—¯</b>ã€ï¼ˆSOAPã¯ S/O/A/Pï¼‰</div>
      <div>4) ã€Œ<b>çµ‚äº†</b>ã€ã§å…¥åŠ›å®Œäº†ï¼ˆç”Ÿæˆâ†’ã‚³ãƒ”ãƒ¼ï¼‰</div>
      <div style="margin-top:6px; opacity:.85;">â€»ã€Œã‚¨ãƒ•ã€ã€Œãƒ‡ã‚£ãƒ¼ã€ãªã©ã‚‚å¸åã€‚é …ç›®ãªã—ã®ç™ºè©±ã¯æœ€å¾Œã®é …ç›®ã¸å…¥ã‚Šã¾ã™ã€‚</div>
    </div>

    <div class="outTitle">å‡ºåŠ›ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</div>
    <pre id="out"></pre>
  </div>

  <button id="mic" class="micBtn" type="button">ğŸ™ï¸ éŸ³å£°é–‹å§‹</button>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  // â˜…ã“ã“ã‚’è‡ªåˆ†ã® Worker URL ã«å·®ã—æ›¿ãˆï¼ˆä¾‹ï¼šhttps://xxx.yyy.workers.dev/transcribeï¼‰
  const TRANSCRIBE_ENDPOINT = "https://YOUR-WORKER-URL/transcribe";

  // ====== æ—¥ä»˜ï¼ˆè‡ªå‹•ï¼‰ ======
  function pad2(n){ return String(n).padStart(2,'0'); }
  function todayYMD(slash=true){
    const d = new Date();
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    return slash ? `${y}/${m}/${dd}` : `${y}-${m}-${dd}`;
  }
  $('date').value = todayYMD(true);

  // ====== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ======
  let mode = 'FDAR'; // FDAR | SOAP
  function setMode(m){
    mode = m;
    $('btnFDAR').classList.toggle('active', mode==='FDAR');
    $('btnSOAP').classList.toggle('active', mode==='SOAP');
    $('panelFDAR').style.display = (mode==='FDAR') ? '' : 'none';
    $('panelSOAP').style.display = (mode==='SOAP') ? '' : 'none';
    lastSection = null;
    render();
  }
  $('btnFDAR').addEventListener('click', ()=>setMode('FDAR'));
  $('btnSOAP').addEventListener('click', ()=>setMode('SOAP'));

  // ====== çŠ¶æ…‹ ======
  let listening = false;   // ã€Œé–‹å§‹ã€å¾Œã®å…¥åŠ›ä¸­
  let armed = false;       // ãƒã‚¤ã‚¯èµ·å‹•æ¸ˆã¿ï¼ˆé–‹å§‹å¾…ã¡ï¼‰
  let lastSection = null;  // æœ€å¾Œã«å…¥ã‚ŒãŸæ¬„

  const START_WORDS = ['é–‹å§‹','ã¯ã˜ã‚','ã‚¹ã‚¿ãƒ¼ãƒˆ','start'];
  const END_WORDS   = ['çµ‚äº†','çµ‚ã‚ã‚Š','ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥','finish','stop'];

  const JP_TO_SECTION_FDAR = [
    ['F','f'], ['ã‚¨ãƒ•','f'], ['ãˆãµ','f'],
    ['D','d'], ['ãƒ‡ã‚£ãƒ¼','d'], ['ã§ãƒãƒ¼','d'], ['ãƒ‡ã‚£','d'], ['ã§ãƒ','d'],
    ['A','a'], ['ã‚¨ãƒ¼','a'], ['ãˆãƒ¼','a'], ['ã‚¨ã‚¤','a'], ['ãˆã„','a'],
    ['R','r'], ['ã‚¢ãƒ¼ãƒ«','r'], ['ã‚ãƒ¼ã‚‹','r'],
  ];
  const JP_TO_SECTION_SOAP = [
    ['S','s'], ['ã‚¨ã‚¹','s'], ['ãˆã™','s'],
    ['O','o'], ['ã‚ªãƒ¼','o'], ['ãŠãƒ¼','o'],
    ['A','a2'], ['ã‚¨ãƒ¼','a2'], ['ãˆãƒ¼','a2'], ['ã‚¨ã‚¤','a2'], ['ãˆã„','a2'],
    ['P','p'], ['ãƒ”ãƒ¼','p'], ['ã´ãƒ¼','p'],
  ];

  function normalizeText(t){
    return (t||'').replace(/\s+/g,' ').replace(/ã€€/g,' ').trim();
  }
  function isStartWord(t){ t = t.toLowerCase(); return START_WORDS.some(w => t === w); }
  function isEndWord(t){ t = t.toLowerCase(); return END_WORDS.some(w => t === w); }

  function parseClient(t){
    const x = t.replace(/\s+/g,'').replace(/ã•ã¾$/,'æ§˜');
    const m = x.match(/^([A-Zï¼¡-ï¼º]{1,4})æ§˜?$/);
    if(!m) return null;
    const raw = m[1].replace(/[ï¼¡-ï¼º]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    return raw + 'æ§˜';
  }

  function mapSectionToken(token){
    const map = (mode==='FDAR') ? JP_TO_SECTION_FDAR : JP_TO_SECTION_SOAP;
    for(const [k,v] of map){
      if(token === k) return v;
    }
    return null;
  }

  function parseSectionLine(t){
    const m = t.match(/^(.{1,6})[ã€,:\uFF1A]\s*(.+)$/);
    if(m){
      const head = normalizeText(m[1]);
      const body = normalizeText(m[2]);
      const sec = mapSectionToken(head);
      if(sec) return { sec, body };
    }
    const m2 = t.match(/^(.{1,6})\s+(.+)$/);
    if(m2){
      const head = normalizeText(m2[1]);
      const body = normalizeText(m2[2]);
      const sec = mapSectionToken(head);
      if(sec) return { sec, body };
    }
    const secOnly = mapSectionToken(t);
    if(secOnly) return { sec: secOnly, body: '' };
    return null;
  }

  function firstSectionId(){
    return (mode==='FDAR') ? 'f' : 's';
  }
  function defaultTarget(){
    return lastSection || firstSectionId();
  }
  function appendToField(fieldId, text){
    const el = $(fieldId);
    if(!el || !text) return;
    const cur = (el.value || '').trimEnd();
    el.value = cur ? (cur + '\n' + text) : text;
    lastSection = fieldId;
    render();
  }

  // ====== å‡ºåŠ›ç”Ÿæˆ ======
  function buildText(){
    const dateISO = todayYMD(false);
    const client = normalizeText($('client').value);
    if(mode==='FDAR'){
      const f = normalizeText($('f').value);
      const d = normalizeText($('d').value);
      const a = normalizeText($('a').value);
      const r = normalizeText($('r').value);
      return [
        dateISO,
        client ? `åˆ©ç”¨è€…ï¼š${client}` : '',
        `Fï¼š${f}`,
        `Dï¼š${d}`,
        `Aï¼š${a}`,
        `Rï¼š${r}`,
      ].filter(Boolean).join('\n');
    } else {
      const s = normalizeText($('s').value);
      const o = normalizeText($('o').value);
      const a2 = normalizeText($('a2').value);
      const p = normalizeText($('p').value);
      return [
        dateISO,
        client ? `åˆ©ç”¨è€…ï¼š${client}` : '',
        `Sï¼š${s}`,
        `Oï¼š${o}`,
        `Aï¼š${a2}`,
        `Pï¼š${p}`,
      ].filter(Boolean).join('\n');
    }
  }
  function render(){ $('out').textContent = buildText(); }
  render();

  // ====== ã‚³ãƒ”ãƒ¼ ======
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
    }catch(_){
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }
    $('status').textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
    setTimeout(()=> $('status').textContent = listening ? 'éŸ³å£°å…¥åŠ›ä¸­' : (armed ? 'é–‹å§‹å¾…ã¡' : 'å¾…æ©Ÿä¸­'), 900);
  }

  $('buildCopy').addEventListener('click', async ()=>{
    render();
    await copyText($('out').textContent);
  });

  $('clearAll').addEventListener('click', ()=>{
    $('client').value = '';
    lastSection = null;
    if(mode==='FDAR'){
      $('f').value=''; $('d').value=''; $('a').value=''; $('r').value='';
    }else{
      $('s').value=''; $('o').value=''; $('a2').value=''; $('p').value='';
    }
    $('status').textContent = armed ? 'é–‹å§‹å¾…ã¡' : 'å¾…æ©Ÿä¸­';
    render();
  });

  // ====== æ–‡å­—èµ·ã“ã—ï¼ˆéŒ²éŸ³â†’ã‚µãƒ¼ãƒï¼‰ ======
  let stream = null;
  let mr = null;
  let chunks = [];

  async function armMic(){
    // iPhoneã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ç´ã¥ã getUserMediaã€ãŒå¿…é ˆ
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mr = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    chunks = [];
    mr.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
    mr.onstop = async ()=>{
      try{
        $('status').textContent = 'è§£æä¸­';
        const blob = new Blob(chunks, { type: 'audio/webm' });
        chunks = [];

        const fd = new FormData();
        fd.append('file', blob, 'audio.webm');
        fd.append('lang', 'ja');

        const res = await fetch(TRANSCRIBE_ENDPOINT, { method:'POST', body: fd });
        if(!res.ok) throw new Error('transcribe failed');
        const data = await res.json();
        const t = normalizeText(data.text || '');

        if(t) handleTranscript(t);
        $('status').textContent = listening ? 'éŸ³å£°å…¥åŠ›ä¸­' : 'é–‹å§‹å¾…ã¡';
      }catch(_){
        $('status').textContent = 'éŸ³å£°ã‚¨ãƒ©ãƒ¼';
        setTimeout(()=> $('status').textContent = listening ? 'éŸ³å£°å…¥åŠ›ä¸­' : (armed ? 'é–‹å§‹å¾…ã¡' : 'å¾…æ©Ÿä¸­'), 1200);
      }
    };

    armed = true;
    $('status').textContent = 'é–‹å§‹å¾…ã¡';
  }

  function disarmMic(){
    armed = false;
    listening = false;
    $('mic').classList.remove('listening');
    $('mic').textContent = 'ğŸ™ï¸ éŸ³å£°é–‹å§‹';
    $('status').textContent = 'å¾…æ©Ÿä¸­';
    try{ mr && mr.state !== 'inactive' && mr.stop(); }catch(_){}
    try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){}
    stream = null; mr = null; chunks = [];
  }

  function startUtteranceCapture(){
    if(!armed || !mr) return;
    if(mr.state === 'recording') return;
    chunks = [];
    mr.start();
    // 2.8ç§’ã§1ãƒ•ãƒ¬ãƒ¼ã‚ºã¨ã—ã¦ç¢ºå®šï¼ˆé‹ç”¨ã§èª¿æ•´ï¼‰
    setTimeout(()=>{
      try{ if(mr && mr.state === 'recording') mr.stop(); }catch(_){}
    }, 2800);
  }

  // ====== è§£æãƒ«ãƒ¼ãƒ«ï¼ˆé–‹å§‹â†’åˆ©ç”¨è€…â†’F/D/A/Râ†’çµ‚äº†ï¼‰ ======
  function handleTranscript(t){
    // é–‹å§‹/çµ‚äº†
    if(isStartWord(t)){
      listening = true;
      $('mic').classList.add('listening');
      $('mic').textContent = 'â›” éŸ³å£°åœæ­¢';
      $('status').textContent = 'éŸ³å£°å…¥åŠ›ä¸­';
      lastSection = firstSectionId();
      return;
    }
    if(isEndWord(t)){
      listening = false;
      $('mic').classList.remove('listening');
      $('mic').textContent = 'ğŸ™ï¸ éŸ³å£°é–‹å§‹';
      $('status').textContent = 'é–‹å§‹å¾…ã¡';
      render();
      copyText($('out').textContent);
      return;
    }

    // åˆ©ç”¨è€…
    const c = parseClient(t);
    if(c){
      $('client').value = c;
      lastSection = firstSectionId();
      render();
      return;
    }

    // é …ç›®è¡Œ
    const secLine = parseSectionLine(t);
    if(secLine){
      if(secLine.body){
        appendToField(secLine.sec, secLine.body);
      }else{
        lastSection = secLine.sec;
        $('status').textContent = 'éŸ³å£°å…¥åŠ›ä¸­';
      }
      return;
    }

    // ãã‚Œä»¥å¤–ã¯æœ€å¾Œã®æ¬„ã¸
    appendToField(defaultTarget(), t);
  }

  // ====== ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®æŒ™å‹• ======
  $('mic').addEventListener('click', async ()=>{
    // 1å›ç›®ï¼šèµ·å‹•ï¼ˆé–‹å§‹å¾…ã¡ï¼‰
    if(!armed){
      try{
        $('status').textContent = 'ãƒã‚¤ã‚¯è¨±å¯ä¸­';
        await armMic();
      }catch(_){
        $('status').textContent = 'ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦';
        setTimeout(()=> $('status').textContent = 'å¾…æ©Ÿä¸­', 1200);
      }
      return;
    }

    // èµ·å‹•æ¸ˆã¿ï¼šç™ºè©±ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆã¾ãŸã¯åœæ­¢ï¼‰
    if(listening){
      // å…¥åŠ›ä¸­ã«æŠ¼ã—ãŸã‚‰åœæ­¢ï¼ˆå®‰å…¨ï¼‰
      listening = false;
      $('mic').classList.remove('listening');
      $('mic').textContent = 'ğŸ™ï¸ éŸ³å£°é–‹å§‹';
      $('status').textContent = 'é–‹å§‹å¾…ã¡';
      return;
    }

    // é–‹å§‹å¾…ã¡çŠ¶æ…‹ï¼šæŠ¼ã™â†’çŸ­æ™‚é–“éŒ²éŸ³â†’æ–‡å­—èµ·ã“ã—â†’ã€Œé–‹å§‹ã€ãªã©ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‹¾ã†
    startUtteranceCapture();
  });

})();
</script>
</body>
</html>
