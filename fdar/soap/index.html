<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>FDARãƒ»SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼ï½œSOAPç‰ˆ</title>
  <meta name="apple-mobile-web-app-title" content="SOAP è‡ªå‹•è¨˜éŒ²" />
  <meta name="application-name" content="SOAP è‡ªå‹•è¨˜éŒ²" />

  <!-- ã„ã¾ root ã« icon-512.png ãŒã‚ã‚‹æƒ³å®šã€‚ã‚‚ã—é•ã†ãªã‚‰ã€Œå®Ÿåœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã€ã«åˆã‚ã›ã¦ãã ã•ã„ -->
  <link rel="icon" href="../icon-512.png">
  <link rel="apple-touch-icon" href="../icon-512.png">

  <style>
    :root { color-scheme: light dark; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      margin:0; padding:18px;
      max-width:860px;
      line-height:1.45;
    }
    h1{ font-size:20px; margin:0 0 6px; }
    .subTitle{ opacity:.85; font-size:13px; margin:0 0 16px; }
    .card{
      border:1px solid rgba(127,127,127,.30);
      border-radius:16px;
      padding:14px;
      margin:12px 0;
      background:rgba(127,127,127,.06);
    }
    label{ display:block; font-size:12px; opacity:.85; margin:10px 0 6px; }
    input, textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid rgba(127,127,127,.35);
      border-radius:12px;
      padding:10px 12px;
      font-size:15px;
      background:rgba(20,20,20,.04);
    }
    textarea{ min-height:84px; resize:vertical; }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:1px solid rgba(127,127,127,.35);
      background:rgba(20,20,20,.06);
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
    }
    .out{
      width:100%;
      min-height:140px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      margin-top:12px;
    }
    .note{ font-size:12px; opacity:.8; margin-top:10px; }
    .warn{ font-size:12px; opacity:.85; }
    a{ color:inherit; }
  </style>
</head>

<body>
  <h1>SOAP è‡ªå‹•è¨˜éŒ²ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
  <p class="subTitle">éŸ³å£°ã§ã€Œã‚¹ã‚¿ãƒ¼ãƒˆ â†’ ã‚¤ãƒ‹ã‚·ãƒ£ãƒ« â†’ S â†’ O â†’ A â†’ P â†’ çµ‚ã‚ã‚Šã€ã§å…¥åŠ›ã—ã€ãƒ¯ãƒ³ã‚¿ãƒƒãƒã§ã‚³ãƒ¼ãƒ‰åŒ–ï¼†ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚</p>

  <div class="card">
    <div class="row">
      <div>
        <label>åˆ©ç”¨è€…ï¼ˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ï¼‰</label>
        <input id="client" placeholder="ä¾‹ï¼šAæ§˜ / KM ãªã©ï¼ˆå€‹äººãŒç‰¹å®šã§ãã‚‹æƒ…å ±ã¯å…¥åŠ›ã—ãªã„é‹ç”¨æ¨å¥¨ï¼‰" />
      </div>
      <div>
        <label>æ—¥ä»˜</label>
        <input id="date" type="date" />
      </div>
    </div>

    <label>Sï¼ˆä¸»è¦³ï¼‰</label>
    <textarea id="s" placeholder="ä¾‹ï¼šæœ¬äººè¨´ãˆã€ç—›ã¿ã€ä½“èª¿ã€å¸Œæœ› ãªã©"></textarea>

    <label>Oï¼ˆå®¢è¦³ï¼‰</label>
    <textarea id="o" placeholder="ä¾‹ï¼šãƒã‚¤ã‚¿ãƒ«ã€æ‰€è¦‹ã€å‹•ä½œã€è¦³å¯Ÿ ãªã©"></textarea>

    <label>Aï¼ˆè©•ä¾¡ï¼‰</label>
    <textarea id="a" placeholder="ä¾‹ï¼šè§£é‡ˆã€å•é¡Œç‚¹ã€è¦å› ã€ãƒªã‚¹ã‚¯ ãªã©"></textarea>

    <label>Pï¼ˆè¨ˆç”»ï¼‰</label>
    <textarea id="p" placeholder="ä¾‹ï¼šå®Ÿæ–½å†…å®¹ã€æ¬¡å›æ–¹é‡ã€æŒ‡å° ãªã©"></textarea>

    <div class="btnRow">
      <button id="render">ã‚³ãƒ¼ãƒ‰åŒ–</button>
      <button id="copy">ã‚³ãƒ¼ãƒ‰åŒ–ï¼†ã‚³ãƒ”ãƒ¼</button>
      <button id="clear">ã‚¯ãƒªã‚¢</button>
    </div>

    <textarea id="out" class="out" placeholder="ã“ã“ã«ã‚³ãƒ¼ãƒ‰ãŒå‡ºåŠ›ã•ã‚Œã¾ã™" readonly></textarea>

    <p class="note">â€»å€‹äººæƒ…å ±ï¼ˆæ°åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ãªã©ï¼‰ã¯å…¥åŠ›ã—ãªã„é‹ç”¨ã«ã—ã¦ãã ã•ã„ã€‚ç«¯æœ«å†…ä¿å­˜ï¼ˆlocalStorageï¼‰ã§ã™ã€‚</p>
  </div>

  <p class="warn">
    éŸ³å£°å…¥åŠ›ã¯ iPhone Safari ã ã¨ã€Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç›´å¾Œã®ã¿ã€å®‰å®šã—ã¾ã™ã€‚åå¿œã—ãªã„å ´åˆã¯ã€ŒéŸ³å£°é–‹å§‹ã€ã‚’æŠ¼ã—ç›´ã—ã¦ãã ã•ã„ã€‚
  </p>

<script>
(() => {
  const el = {
    client: document.getElementById('client'),
    date: document.getElementById('date'),
    s: document.getElementById('s'),
    o: document.getElementById('o'),
    a: document.getElementById('a'),
    p: document.getElementById('p'),
    out: document.getElementById('out'),
    renderBtn: document.getElementById('render'),
    copyBtn: document.getElementById('copy'),
    clearBtn: document.getElementById('clear'),
  };

  const today = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  };
  if (!el.date.value) el.date.value = today();

  // ç«¯æœ«å†…ä¿å­˜ï¼šã‚¤ãƒ‹ã‚·ãƒ£ãƒ«å˜ä½ï¼ˆä¾‹: KMï¼‰
  const keyFor = (ini) => `soap_saved_${ini}`;
  const getInitial = () => (el.client.value || '').trim().toUpperCase();

  const saveForInitial = () => {
    const ini = getInitial();
    if (!ini) return;
    const data = {
      client: ini,
      s: el.s.value || '',
      o: el.o.value || '',
      a: el.a.value || '',
      p: el.p.value || '',
      updatedAt: Date.now(),
    };
    localStorage.setItem(keyFor(ini), JSON.stringify(data));
  };

  const loadForInitial = (ini) => {
    try {
      const raw = localStorage.getItem(keyFor(ini));
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  };

  const fillFromSaved = (saved) => {
    if (!saved) return;
    el.client.value = saved.client || el.client.value;
    el.s.value = saved.s || '';
    el.o.value = saved.o || '';
    el.a.value = saved.a || '';
    el.p.value = saved.p || '';
  };

  const makeText = () => {
    const client = (el.client.value || '').trim();
    const date = (el.date.value || '').trim();
    const S = (el.s.value || '').trim();
    const O = (el.o.value || '').trim();
    const A = (el.a.value || '').trim();
    const P = (el.p.value || '').trim();

    // noteç­‰ã«è²¼ã‚Šã‚„ã™ã„æœ€å°æ§‹æˆï¼ˆå¿…è¦ãªã‚‰ã“ã“ã‚’å¥½ãã«å¤‰ãˆã¦OKï¼‰
    return [
      `ã€SOAPã€‘${client ? ` ${client}` : ''}${date ? `ï¼ˆ${date}ï¼‰` : ''}`,
      '',
      `Sï¼š${S}`,
      `Oï¼š${O}`,
      `Aï¼š${A}`,
      `Pï¼š${P}`,
    ].join('\n');
  };

  const render = () => {
    el.out.value = makeText();
    saveForInitial();
  };

  const renderAndCopy = async () => {
    render();
    const text = el.out.value;
    try {
      await navigator.clipboard.writeText(text);
      const old = el.copyBtn.textContent;
      el.copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
      setTimeout(() => (el.copyBtn.textContent = old), 1200);
    } catch {
      el.out.focus(); el.out.select();
      document.execCommand('copy');
    }
  };

  el.renderBtn.addEventListener('click', render);
  el.copyBtn.addEventListener('click', renderAndCopy);
  el.clearBtn.addEventListener('click', () => {
    el.s.value = '';
    el.o.value = '';
    el.a.value = '';
    el.p.value = '';
    el.out.value = '';
  });

  // ===== éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ï¼ˆçŠ¶æ…‹é·ç§»ï¼‰=====
  // ã€Œã‚¹ã‚¿ãƒ¼ãƒˆ/ã¯ã˜ã‚/é–‹å§‹ã€ â†’ åˆ©ç”¨è€…ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
  // ã€ŒS/O/A/Pã€ â†’ ãã®æ¬„ã«å…¥åŠ›
  // ã€Œçµ‚ã‚ã‚Š/ãŠã‚ã‚Š/çµ‚äº†ã€ â†’ ã‚³ãƒ¼ãƒ‰åŒ–ï¼†ã‚³ãƒ”ãƒ¼
  // ã€Œå…¨éƒ¨å¤‰ã‚ã‚Šãªã—/ãœã‚“ã¶ã‹ã‚ã‚Šãªã—ã€ â†’ å‰å›ä¿å­˜ã‚’èª­ã¿è¾¼ã¿ã€æ—¥ä»˜ã‚’ä»Šæ—¥ã«ã—ã¦ã‚³ãƒ¼ãƒ‰åŒ–ï¼†ã‚³ãƒ”ãƒ¼
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  // æ—¢ã«ä½œã‚‰ã‚Œã¦ã„ãŸã‚‰äºŒé‡ç”Ÿæˆã—ãªã„ï¼ˆå´©ã‚Œé˜²æ­¢ï¼‰
  if (!document.getElementById('micBtn')) {
    const micBtn = document.createElement('button');
    micBtn.id = 'micBtn';
    micBtn.type = 'button';
    micBtn.textContent = 'ğŸ™ éŸ³å£°é–‹å§‹';
    micBtn.style.cssText = `
      position:fixed; right:16px; bottom:16px; z-index:99999;
      padding:12px 14px; border-radius:14px;
      border:1px solid rgba(127,127,127,.35);
      background:rgba(20,20,20,.92); color:#fff; font-size:14px;
    `;
    document.body.appendChild(micBtn);

    const badge = document.createElement('div');
    badge.id = 'micBadge';
    badge.textContent = 'å¾…æ©Ÿä¸­';
    badge.style.cssText = `
      position:fixed; right:16px; bottom:64px; z-index:99999;
      padding:8px 10px; border-radius:12px;
      border:1px solid rgba(127,127,127,.25);
      background:rgba(20,20,20,.70); color:#ddd; font-size:12px;
    `;
    document.body.appendChild(badge);

    const MODE = { IDLE:'idle', NAME:'name', S:'s', O:'o', A:'a', P:'p' };
    let mode = MODE.IDLE;

    const setMode = (m) => {
      mode = m;
      const label = {
        [MODE.IDLE]:'å¾…æ©Ÿä¸­',
        [MODE.NAME]:'å…¥åŠ›ï¼šã‚¤ãƒ‹ã‚·ãƒ£ãƒ«',
        [MODE.S]:'å…¥åŠ›ï¼šS',
        [MODE.O]:'å…¥åŠ›ï¼šO',
        [MODE.A]:'å…¥åŠ›ï¼šA',
        [MODE.P]:'å…¥åŠ›ï¼šP',
      }[m] || 'å¾…æ©Ÿä¸­';
      badge.textContent = label;
    };
    setMode(MODE.IDLE);

    const norm = (s) => (s || '')
      .trim()
      .replace(/[ï¼!ã€‚ã€ï¼ï¼Œ]/g,'')
      .replace(/[ ã€€\s]+/g,' ')
      .toLowerCase();

    const isStart = (t) => ['ã‚¹ã‚¿ãƒ¼ãƒˆ','ã¯ã˜ã‚','é–‹å§‹'].some(w => t.includes(w));
    const isEnd = (t) => ['çµ‚ã‚ã‚Š','ãŠã‚ã‚Š','çµ‚äº†','ã—ã‚…ã†ã‚Šã‚‡ã†'].some(w => t.includes(w));
    const isSame = (t) => ['å…¨éƒ¨å¤‰ã‚ã‚Šãªã—','ãœã‚“ã¶ã‹ã‚ã‚Šãªã—','å…¨ã¦å¤‰ã‚ã‚Šãªã—','ã™ã¹ã¦ã‹ã‚ã‚Šãªã—'].some(w => t.includes(w));

    const wantS = (t) => ['s','ãˆã™','ã‚¨ã‚¹'].some(w => t.includes(w));
    const wantO = (t) => ['o','ãŠãƒ¼','ã‚ªãƒ¼','ãŠ'].some(w => t === w || t.includes('ãŠãƒ¼') || t.includes('ã‚ªãƒ¼'));
    const wantA = (t) => ['a','ãˆãƒ¼','ã‚¨ãƒ¼','ã‚'].some(w => t === w || t.includes('ãˆãƒ¼') || t.includes('ã‚¨ãƒ¼'));
    const wantP = (t) => ['p','ã´ãƒ¼','ãƒ”ãƒ¼'].some(w => t.includes(w));

    const append = (targetEl, text) => {
      const cur = targetEl.value || '';
      const add = (text || '').trim();
      if (!add) return;
      targetEl.value = cur ? (cur + '\n' + add) : add;
    };

    const applySameAsSaved = () => {
      const ini = getInitial();
      if (!ini) return;
      const saved = loadForInitial(ini);
      if (!saved) return;
      el.date.value = today();     // æ—¥ä»˜ã¯ä»Šæ—¥
      fillFromSaved(saved);        // å‰å›ã‚’å…¥ã‚Œã‚‹
      renderAndCopy();             // å‡ºåŠ›ï¼†ã‚³ãƒ”ãƒ¼ï¼ˆä¿å­˜ã‚‚æ›´æ–°ï¼‰
      setMode(MODE.IDLE);
    };

    const onInitialSpoken = (raw) => {
      const ini = (raw || '').trim().toUpperCase();
      if (!ini) return;
      el.client.value = ini;
      el.date.value = today();

      const saved = loadForInitial(ini);
      if (saved) fillFromSaved(saved);

      setMode(MODE.S);
    };

    const handleText = (raw) => {
      const t = norm(raw);

      if (isStart(t)) { setMode(MODE.NAME); return; }
      if (isSame(t))  { applySameAsSaved(); return; }
      if (isEnd(t))   { renderAndCopy(); setMode(MODE.IDLE); return; }

      if (wantS(t)) { setMode(MODE.S); return; }
      if (wantO(t)) { setMode(MODE.O); return; }
      if (wantA(t)) { setMode(MODE.A); return; }
      if (wantP(t)) { setMode(MODE.P); return; }

      if (mode === MODE.NAME) { onInitialSpoken(raw); return; }
      if (mode === MODE.S) { append(el.s, raw); return; }
      if (mode === MODE.O) { append(el.o, raw); return; }
      if (mode === MODE.A) { append(el.a, raw); return; }
      if (mode === MODE.P) { append(el.p, raw); return; }
      // å¾…æ©Ÿä¸­ã®èª¤çˆ†ã¯ç„¡è¦–
    };

    let rec = null;
    let listening = false;

    const startRec = () => {
      if (!SpeechRecognition) {
        alert('ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°èªè­˜ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        return;
      }
      rec = new SpeechRecognition();
      rec.lang = 'ja-JP';
      rec.interimResults = false;
      rec.continuous = true;

      rec.onresult = (e) => {
        const last = e.results[e.results.length - 1];
        const text = last && last[0] ? last[0].transcript : '';
        if (text) handleText(text);
      };

      rec.onend = () => {
        // iOSã§æ­¢ã¾ã‚Šã‚„ã™ã„ã®ã§å†é–‹ã‚’è©¦ã™
        if (listening) { try { rec.start(); } catch {} }
      };

      try { rec.start(); } catch {}
    };

    const stopRec = () => {
      if (!rec) return;
      try { rec.stop(); } catch {}
      rec = null;
    };

    micBtn.addEventListener('click', () => {
      listening = !listening;
      micBtn.textContent = listening ? 'ğŸ›‘ éŸ³å£°åœæ­¢' : 'ğŸ™ éŸ³å£°é–‹å§‹';
      if (listening) startRec();
      else stopRec();
    });
  }
})();
</script>
</body>
</html>
